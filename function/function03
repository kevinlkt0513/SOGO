功能 3  findHccEventInfo — 查詢使用者參加指定分館活動的詳細資訊
請求參數
參數名稱
說明
hccEventType
活動類型（例如：NORMAL_DEDUCT_POINT）
memberTypes
使用者所屬會員類型清單（例如：SOGO_VIP, SOGO_VVIP）
appId
使用者 App ID
branchId
指定要查詢的分館代碼（例如：BRANCH_JS）


請求範例
{
    "hccEventType": "NORMAL_DEDUCT_POINT",
    "memberTypes": ["SOGO_VIP", "SOGO_VVIP"],
    "appId": "A000111222",
    "branchId": "BRANCH_JS"
}

回傳資料（活動資訊）
欄位名
說明
eventNo
活動編號
eventBranchId
活動所屬分館代碼
eventName
活動名稱
startDate
活動開始時間
endDate
活動結束時間
usingBranchIds
本活動適用的分館代碼組合（用 / 分隔）
usingBranchNames
本活動適用的分館名稱組合（用 / 分隔）
giftInforUrl
活動資訊頁面網址
giftAttentionUrl
活動注意事項網址
eventMemo
活動備註
prizeCouponJson
中獎/兌換商品的 JSON 設定內容（優惠券資訊）


回傳範例
[
  {
    "eventNo": "EVN000111222",
    "eventBranchId": "BRANCH_JS",
    "eventName": "活動AAA名稱",
    "startDate": "2025-07-01 11:22:33",
    "endDate": "2025-07-31 11:22:33",
    "usingBranchIds": "BRANCH_JS/BRANCH_FS",
    "usingBranchNames": "忠孝館/復興館",
    "giftInforUrl": "https://sogo.com.tw/info/aaa",
    "giftAttentionUrl": "https://sogo.com.tw/att/aaa",
    "eventMemo": "活動AAA備註",
    "prizeCouponJson": "[...]"
  }
]

SQL 查詢邏輯與中文註解
第一段：查出符合條件的活動資訊（activity list）

SELECT *
FROM gif_hcc_event he  -- 活動主表，含活動所屬分館、是否限 App 等
LEFT JOIN gif_event e 
  ON he.event_no = e.event_no  -- 一般活動資訊：活動名稱、活動開始／結束時間、狀態等
LEFT JOIN gif_event_coupon_setting ecs 
  ON e.event_no = ecs.event_no  -- 活動對應的優惠券設定
LEFT JOIN gif_event_coupon_burui ecb 
  ON ecs.coupon_setting_no = ecb.coupon_setting_no  -- 優惠券適用的分館資訊（用於找出 usingBranchIds 和 Names）
WHERE 1 = 1
  AND he.branch = :branchId  -- 過濾指定分館舉辦的活動
  AND e.exchange_start_date < LOCALTIMESTAMP  -- 活動兌換起始時間早於現在（已開始）
  AND e.exchange_end_date >= LOCALTIMESTAMP   -- 活動兌換結束時間晚於現在（尚未結束）
  AND e.event_status = 'USING'  -- 活動狀態為啟用中
  AND he.only_app = 'Y'         -- 僅限 App 用戶參與
  AND he.hcc_event_type = :hccEventType; -- 活動類型必須符合匹配

第二段：檢查是否符合參加人名單（若 all_member = N）
SELECT 1 
FROM gif_hcc_event_attendee
WHERE event_no = :eventNo
  AND app_id = :appId;

第三段：檢查是否符合會員類型名單（若是 CLUB 類型活動）
SELECT 1 
FROM gif_hcc_event_member_type 
WHERE event_no = :eventNo
  AND member_type IN (:memberTypes);



 附註：關於 usingBranchIds 和 usingBranchNames 的預先處理建議
資料組裝邏輯：
usingBranchIds 組裝邏輯
查出 gif_event ➝ gif_event_coupon_setting ➝ gif_event_coupon_burui 對應的所有 branch 值。
依據 branch 對照中的 orderIndex 欄位排序。
利用 '/' 字元進行合併（JOIN）。
usingBranchNames 組裝邏輯
和上面一樣查出所有適用的 branchId。
結合 branch 對照表將 branchId 對應成 branchName。
依據 orderIndex 排序。
同樣用 '/' 合併成字串值。

分館對照表（Branch 對應名稱與排序）
branchId
branchName
orderIndex
BRANCH_TAIWAN
全台
1
BRANCH_TAIPEI
台北店
2
BRANCH_JS
忠孝館
4
BRANCH_FS
復興館
5
BRANCH_DH
敦化館
6
BRANCH_TM
天母店
7
BRANCH_JL
中壢店
8
BRANCH_BC
新竹店
9
BRANCH_GS
高雄店
10
BRANCH_GC
Garden City
12
BRANCH_GCA
Garden City-A區
13
BRANCH_GCB
Garden City-B區
14
BRANCH_GCC
Garden City-C區
15
BRANCH_GCD
Garden City-D區
16

=====================================================================

功能 3  findHccEventInfo — 查詢使用者參加指定分館活動的詳細資訊
const hccEventType = "NORMAL_DEDUCT_POINT";
const memberTypes = ["SOGO_VIP", "SOGO_VVIP"];
const appId = "A000111222";
const branchId = "BRANCH_JS";
const now = new Date();

db.events.aggregate([

  // 1️⃣ 初步篩選符合條件的活動（分館 + 時間 + 開放平台 + 類型）
  {
    $match: {
      eventStatus: "USING",                   // 活動啟用中
      onlyApp: true,                          // 限 App 參加
      hccEventType: hccEventType,             // 符合指定活動類型
      eventBranchId: branchId,                // 指定分館主辦活動
      startDate: { $lte: now },               // 已開始
      endDate: { $gte: now },                 // 尚未結束
      $or: [
        { hccEventType: { $ne: "CLUB_DEDUCT_POINT" } },     // 非 CLUB 活動
        { memberTypes: { $in: memberTypes } }               // CLUB 活動需檢查會員身分
      ]
    }
  },

  // 2️⃣ 加入 event_attendees：查找使用者是否在參與名單中
  {
    $lookup: {
      from: "event_attendees",
      let: { eventNo: "$_id" },
      pipeline: [
        {
          $match: {
            $expr: {
              $and: [
                { $eq: ["$eventNo", "$$eventNo"] },
                { $eq: ["$appId", appId] }
              ]
            }
          }
        },
        { $limit: 1 }
      ],
      as: "matchedAttendee"
    }
  },

  // 3️⃣ 判斷活動是否開放會員或 app_id 是否在名單中
  {
    $match: {
      $or: [
        { allMember: true },
        { "matchedAttendee.0": { $exists: true } }
      ]
    }
  },

  // 4️⃣ 輸出格式處理：直接輸出陣列欄位，不做合併字串
  {
    $project: {
      _id: 0,
      eventNo: "$_id",              // 活動主鍵
      eventBranchId: 1,             // 活動所屬分館
      eventName: "$name",           // 活動名稱
      startDate: 1,
      endDate: 1,
      usingBranchIds: 1,            // 直接輸出陣列，不合併
      usingBranchNames: 1,
      giftInforUrl: 1,
      giftAttentionUrl: 1,
      eventMemo: 1,
      prizeCouponJson: 1
    }
  }

]).toArray()



