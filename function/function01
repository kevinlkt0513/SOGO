åŠŸèƒ½ 1 hasHccEvent - åˆ¤æ–·ä½¿ç”¨è€…æ˜¯å¦ç¬¦åˆæŸæ´»å‹•çš„åƒåŠ è³‡æ ¼

    è«‹æ±‚åƒæ•¸
        String hccEventType, List<String> memberTypes, String appId
    ç¯„ä¾‹
        {
            "hccEventType": "NORMAL_DEDUCT_POINT",
            "memberTypes": ["SOGO_VIP", "SOGO_VVIP"],
            "appId": "A000111222"
        }

    å›å‚³è³‡æ–™
        boolean hasEvent
    ç¯„ä¾‹
        {
            "hasEvent": true
        }


èªæ³•
SELECT COUNT(*) 
FROM gif_hcc_event he   -- æ´»å‹•ä¸»è¡¨
LEFT JOIN gif_event e
    ON he.event_no = e.event_no   -- å°æ‡‰é€šç”¨æ´»å‹•è¨­å®š
LEFT JOIN gif_hcc_event_attendee hea
    ON he.event_no = hea.event_no   -- å°æ‡‰åƒåŠ è€…åå–®
LEFT JOIN gif_hcc_event_member_type hem
    ON he.event_no = hem.event_no   -- å°æ‡‰æœƒå“¡é¡å‹è¨­å®š
WHERE 1 = 1
    -- åƒ…è€ƒæ…®ç›®å‰æ™‚é–“ä»åœ¨å…Œæ›æœŸé–“çš„æ´»å‹•
    AND e.exchange_start_date < LOCALTIMESTAMP
    AND e.exchange_end_date >= LOCALTIMESTAMP
    
    -- æ´»å‹•ç‹€æ…‹ç‚ºå•Ÿç”¨ä¸­
    AND e.event_status = 'USING'
    
    -- åƒ…ä¾›AppåƒåŠ çš„æ´»å‹•
    AND he.only_app = 'Y'
    
    -- æŒ‡å®šçš„æ´»å‹•é¡åˆ¥
    AND he.hcc_event_type = :hccEventType
    
    -- è‹¥æ´»å‹•ä¸æ˜¯é–‹æ”¾æ‰€æœ‰æœƒå“¡ï¼Œå‰‡éœ€æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰è¢«åˆ—å…¥åƒåŠ åå–®
    AND (
        he.all_member = 'Y'
        OR (he.all_member = 'N' AND hea.app_id = :appId)
    )
    
    -- è‹¥æ´»å‹•æ˜¯ CLUB_DEDUCT_POINTï¼Œå‰‡å¿…é ˆç¬¦åˆæœƒå“¡é¡å‹é™åˆ¶
    AND (
        he.hcc_event_type <> 'CLUB_DEDUCT_POINT'
        OR (hem.member_type IN (:memberTypes))
    );

è«‹æ±‚åƒæ•¸ï¼š
åƒæ•¸åç¨±
èªªæ˜
hccEventType
æ´»å‹•é¡å‹è­˜åˆ¥ï¼Œexï¼šNORMAL_DEDUCT_POINT
memberTypes
ç”¨æˆ¶æ‰€å±¬çš„æœƒå“¡ç­‰ç´šï¼ˆä¾‹å¦‚ï¼šSOGO_VIP, SOGO_VVIPï¼‰
appId
ä½¿ç”¨è€…åœ¨Appä¸­çš„å”¯ä¸€èº«ä»½ï¼ˆApp IDï¼‰


æ´»å‹•å¿…é ˆæ˜¯é€²è¡Œä¸­çš„ï¼ˆç‹€æ…‹ç‚º 'USING' ä¸”å…Œæ›æœŸé–“å…§ï¼‰
æ´»å‹•å¿…é ˆç‚ºåªé™ App (only_app = 'Y')
æ´»å‹•å¿…é ˆç¬¦åˆæŒ‡å®šçš„é¡å‹ hcc_event_type
è‹¥ all_member = 'Y' è¡¨ç¤ºæ‰€æœ‰æœƒå“¡çš†å¯åƒåŠ ï¼Œå¦å‰‡éœ€æª¢æŸ¥åƒåŠ è€…æ¸…å–®ä¸­æ˜¯å¦å­˜åœ¨æ­¤ä½¿ç”¨è€… (app_id)
è‹¥æ´»å‹•ç‚º CLUB_DEDUCT_POINT é¡å‹ï¼Œå‰‡é‚„éœ€ç”¨æˆ¶çš„ member_type ç¬¦åˆæ´»å‹•è¨­å®š

=================================================
const hccEventType = "NORMAL_DEDUCT_POINT";
const memberTypes = ["SOGO_VIP", "SOGO_VVIP"];
const appId = "A000111222";
const now = new Date();

db.events.aggregate([
  // ğŸ¯ Step 1ï¼šæŒ‘å‡ºç›®å‰é€²è¡Œä¸­ã€ç‹€æ…‹å•Ÿç”¨çš„æ´»å‹•
  {
    $match: {
      hccEventType: hccEventType,             // æ´»å‹•é¡å‹
      eventStatus: "USING",                   // æ´»å‹•ç‹€æ…‹
      onlyApp: true,                          // åªé™ App
      startDate: { $lte: now },               // èµ·å§‹æ™‚é–“åœ¨ç¾åœ¨ä¹‹å‰
      endDate: { $gte: now },                 // çµæŸæ™‚é–“åœ¨ç¾åœ¨ä¹‹å¾Œ
      $or: [
        { hccEventType: { $ne: "CLUB_DEDUCT_POINT" } },    // é club é¡æ´»å‹•
        { memberTypes: { $in: memberTypes } }              // æˆ–ç¬¦åˆæœƒå“¡åˆ¥
      ]
    }
  },

  // ğŸ”— Step 2ï¼šJoin event_attendeesï¼ˆsubquery å…³è”ä¸€ä½ appIdï¼‰
  {
    $lookup: {
      from: "event_attendees",
      let: { eventNo: "$eventNo" },
      pipeline: [
        {
          $match: {
            $expr: {
              $and: [
                { $eq: ["$eventNo", "$$eventNo"] },
                { $eq: ["$appId", appId] }              // åˆ¤æ–·åƒèˆ‡è€…æ˜¯å¦å­˜åœ¨
              ]
            }
          }
        },
        { $limit: 1 }  // æœ€å¿«å–ä¸€ç­†å³å¯
      ],
      as: "matchedAttendee"
    }
  },

  // âœ… Step 3ï¼šéæ¿¾ï¼šå…è¨±åƒåŠ çš„æƒ…æ³
  {
    $match: {
      $or: [
        { allMember: true },                               // é–‹æ”¾æ‰€æœ‰äººåƒåŠ 
        { "matchedAttendee.0": { $exists: true } }         // æˆ–åƒåŠ è€…æœ‰åœ¨åå–®ä¸­
      ]
    }
  },

  // âœ… Step 4ï¼šæ˜¯å¦æœ‰ç¬¦åˆæ¢ä»¶çš„æ´»å‹•
  {
    $limit: 1
  },

  // ğŸ”š Step 5ï¼šè½‰æ›æˆ hasEvent: true çµæœæ ¼å¼
  {
    $project: {
      _id: 0,
      hasEvent: { $literal: true }
    }
  }
]).toArray()
