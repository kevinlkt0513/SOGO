åŠŸèƒ½ 2 findHccEventBranchInfo â€” æŸ¥è©¢ä½¿ç”¨è€…ç¬¦åˆæ´»å‹•è³‡æ ¼çš„åˆ†é¤¨æ¸…å–®
è«‹æ±‚åƒæ•¸
åƒæ•¸åç¨±
èªªæ˜
hccEventType
æ´»å‹•é¡å‹ï¼ˆe.g. NORMAL_DEDUCT_POINTï¼‰
memberTypes
ä½¿ç”¨è€…æ‰€å±¬çš„æœƒå“¡é¡å‹åˆ—è¡¨ï¼ˆe.g. SOGO_VIP, SOGO_VVIPï¼‰
appId
ä½¿ç”¨è€… App ID


ç¯„ä¾‹è¼¸å…¥
{
    "hccEventType": "NORMAL_DEDUCT_POINT",
    "memberTypes": ["SOGO_VIP", "SOGO_VVIP"],
    "appId": "A000111222"
}


å›å‚³è³‡æ–™
æ¬„ä½åç¨±
èªªæ˜
branchId
åˆ†é¤¨ä»£ç¢¼ï¼ˆå¦‚ï¼šBRANCH_JSï¼‰
branchName
åˆ†é¤¨åç¨±ï¼ˆå¦‚ï¼šå¿ å­é¤¨ï¼‰


ç¯„ä¾‹å›å‚³
[
    {
        "branchId": "BRANCH_JS",
        "branchName": "å¿ å­é¤¨"
    },
    {
        "branchId": "BRANCH_FS",
        "branchName": "å¾©èˆˆé¤¨"
    }
]

é‚è¼¯èªªæ˜ï¼š
åƒ…æŒ‘é¸ç›®å‰é€²è¡Œä¸­ (USING) çš„æ´»å‹•ï¼Œä¸”æ™‚é–“ä»ä»‹æ–¼ exchange_start_date å’Œ exchange_end_date é–“ã€‚
æ´»å‹•å¿…é ˆæ˜¯åªé™ App ç”¨æˆ¶åƒèˆ‡ï¼ˆonly_app = 'Y'ï¼‰ã€‚
æ´»å‹•é¡å‹éœ€ç¬¦åˆå‚³å…¥åƒæ•¸ hccEventTypeã€‚
æ´»å‹•è‹¥æ˜¯é‡å°æ‰€æœ‰æœƒå“¡é–‹æ”¾ï¼Œå‰‡ç„¡éœ€æª¢æŸ¥åƒåŠ è€… (hea)ï¼›å¦å‰‡å¿…é ˆæª¢æŸ¥æŒ‡å®šçš„ app_id æ˜¯åœ¨åƒåŠ è€…åå–®å…§ã€‚
è‹¥ç‚º CLUB é¡å‹æ´»å‹•ï¼ˆå¦‚ CLUB_DEDUCT_POINTï¼‰ï¼Œé‚„éœ€æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å…·å‚™é©ç”¨çš„æœƒå“¡é¡å‹ (memberTypes)ã€‚
æŸ¥è©¢çµæœåªè¿”å›ç¬¦åˆæ¢ä»¶çš„æ´»å‹•é©ç”¨çš„åˆ†é¤¨ï¼ˆbranchï¼‰ï¼Œå»é™¤é‡è¦†è³‡æ–™ï¼ˆDISTINCTï¼‰ã€‚
SELECT DISTINCT he.branch -- æ´»å‹•æ‰€å±¬åˆ†é¤¨ï¼ˆå»é‡ï¼‰
FROM gif_hcc_event he
LEFT JOIN gif_event e
  ON he.event_no = e.event_no -- åŠ å…¥æ´»å‹•é€šç”¨è³‡è¨Šï¼ˆç‹€æ…‹ã€æ™‚é–“ç¯„åœç­‰ï¼‰
LEFT JOIN gif_hcc_event_attendee hea
  ON he.event_no = hea.event_no -- åŠ å…¥è©²æ´»å‹•çš„åƒåŠ è€…è³‡æ–™
LEFT JOIN gif_hcc_event_member_type hem
  ON he.event_no = hem.event_no -- åŠ å…¥è©²æ´»å‹•æ”¯æ´çš„æœƒå“¡é¡å‹è³‡æ–™
WHERE 1 = 1
  -- æ™‚é–“æ¢ä»¶ï¼šæ´»å‹•æ­£åœ¨é€²è¡Œä¸­
  AND e.exchange_start_date < LOCALTIMESTAMP
  AND e.exchange_end_date >= LOCALTIMESTAMP

  -- æ´»å‹•ç‹€æ…‹ç‚ºå•Ÿç”¨ä¸­
  AND e.event_status = 'USING'
  
  -- æ´»å‹•é™å®šAppç”¨æˆ¶
  AND he.only_app = 'Y'
  
  -- æ´»å‹•é¡å‹å¿…é ˆç¬¦åˆåƒæ•¸ï¼ˆå¦‚NORMAL_DEDUCT_POINTï¼‰
  AND he.hcc_event_type = :hccEventType
  
  -- æ´»å‹•å°è±¡ï¼šè‹¥éé–‹æ”¾æ‰€æœ‰æœƒå“¡ï¼Œå‰‡ appId å¿…é ˆåœ¨åå–®å…§
  AND (
      he.all_member = 'Y'
      OR (he.all_member = 'N' AND hea.app_id = :appId)
  )
  
  -- è‹¥ç‚º CLUB é¡å‹æ´»å‹•ï¼Œå‰‡ memberType å¿…é ˆç¬¦åˆè³‡æ ¼
  AND (
      he.hcc_event_type <> 'CLUB_DEDUCT_POINT'
      OR (hem.member_type IN (:memberTypes))
  );

=================================================
åŠŸèƒ½ 2 findHccEventBranchInfo â€” æŸ¥è©¢ä½¿ç”¨è€…ç¬¦åˆæ´»å‹•è³‡æ ¼çš„åˆ†é¤¨æ¸…å–®
const hccEventType = "NORMAL_DEDUCT_POINT";
const memberTypes = ["SOGO_VIP", "SOGO_VVIP"];
const appId = "A000111222";
const now = new Date();

db.events.aggregate([

  // ğŸ§Š 1. æ™‚é–“æ¢ä»¶èˆ‡æ´»å‹•é¡å‹åˆæ­¥éæ¿¾
  {
    $match: {
      eventStatus: "USING",                // æ´»å‹•å¿…é ˆæ˜¯å•Ÿç”¨ç‹€æ…‹
      onlyApp: true,                       // åƒ…é™ App æ´»å‹•
      hccEventType: hccEventType,          // æ´»å‹•é¡å‹ç¬¦åˆè¼¸å…¥
      startDate: { $lte: now },            // æ´»å‹•å·²é–‹å§‹
      endDate: { $gte: now },              // æ´»å‹•å°šæœªçµæŸ
      $or: [
        { hccEventType: { $ne: "CLUB_DEDUCT_POINT" } },       // é CLUB é¡å‹
        { memberTypes: { $in: memberTypes } }                 // æˆ–ç¬¦åˆæœƒå“¡é¡å‹
      ]
    }
  },

  // ğŸ§© 2. ä½¿ç”¨è€…æ˜¯å¦åœ¨åå–®å…§ï¼šç”¨ LEFT JOIN æ–¹å¼æ‰¾å‡ºæ˜¯å¦ç‚ºåƒèˆ‡è€…
  {
    $lookup: {
      from: "event_attendees",
      let: { eventNo: "$eventNo" },
      pipeline: [
        {
          $match: {
            $expr: {
              $and: [
                { $eq: ["$eventNo", "$$eventNo"] },
                { $eq: ["$appId", appId] }
              ]
            }
          }
        },
        { $limit: 1 }
      ],
      as: "matchedAttendee"
    }
  },

  // âœ… 3. æ ¹æ“šæœƒå“¡é–‹æ”¾èˆ‡åƒåŠ è€…åå–®é€²è¡Œè³‡æ ¼éæ¿¾
  {
    $match: {
      $or: [
        { allMember: true },                       // è‹¥ç‚ºå…¨æœƒå“¡çš†å¯åƒèˆ‡
        { "matchedAttendee.0": { $exists: true } } // å¦å‰‡éœ€ appId å­˜åœ¨æ–¼åƒåŠ è€…åå–®
      ]
    }
  },

  // ğŸ“¦ 4. å°‡ usingBranchIds é™£åˆ—æ‹†æ•£ç‚ºå–®ä¸€åˆ—ï¼ˆæ¯åˆ—ä¸€å€‹åˆ†é¤¨ä»£ç¢¼ï¼‰
  { $unwind: "$usingBranchIds" },
  { $unwind: "$usingBranchNames" },

  // ğŸ“Œ 5. èšåˆå”¯ä¸€çš„ branchId / branchNameï¼Œé¿å…é‡è¦†
  {
    $group: {
      _id: "$usingBranchIds",
      branchName: { $first: "$usingBranchNames" }
    }
  },

  // ğŸ§¾ 6. æ•´ç†è¼¸å‡ºæ¬„ä½æ ¼å¼
  {
    $project: {
      _id: 0,
      branchId: "$_id",
      branchName: "$branchName"
    }
  }

]).toArray()



